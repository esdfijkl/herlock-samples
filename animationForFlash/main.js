
(function(){

    //==============================================
    //　定義
    //==============================================

    //Flashから書き出したJSONを変数に代入します
    var flashExport = {"frames": [
            {
                "filename": "g0000",
                "frame": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0001",
                "frame": {
                    "x": 200,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0002",
                "frame": {
                    "x": 400,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0003",
                "frame": {
                    "x": 600,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0004",
                "frame": {
                    "x": 800,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0005",
                "frame": {
                    "x": 0,
                    "y": 143,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0006",
                "frame": {
                    "x": 200,
                    "y": 143,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0007",
                "frame": {
                    "x": 400,
                    "y": 143,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0008",
                "frame": {
                    "x": 600,
                    "y": 143,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0009",
                "frame": {
                    "x": 800,
                    "y": 143,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0010",
                "frame": {
                    "x": 0,
                    "y": 286,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0011",
                "frame": {
                    "x": 200,
                    "y": 286,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0012",
                "frame": {
                    "x": 400,
                    "y": 286,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0013",
                "frame": {
                    "x": 600,
                    "y": 286,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0014",
                "frame": {
                    "x": 800,
                    "y": 286,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0015",
                "frame": {
                    "x": 0,
                    "y": 429,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0016",
                "frame": {
                    "x": 200,
                    "y": 429,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0017",
                "frame": {
                    "x": 400,
                    "y": 429,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0018",
                "frame": {
                    "x": 600,
                    "y": 429,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0019",
                "frame": {
                    "x": 800,
                    "y": 429,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0020",
                "frame": {
                    "x": 0,
                    "y": 572,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0021",
                "frame": {
                    "x": 200,
                    "y": 572,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0022",
                "frame": {
                    "x": 400,
                    "y": 572,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0023",
                "frame": {
                    "x": 600,
                    "y": 572,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
            ,
            {
                "filename": "g0024",
                "frame": {
                    "x": 800,
                    "y": 572,
                    "w": 200,
                    "h": 143
                },
                "rotated": false,
                "trimmed": false,
                "spriteSourceSize": {
                    "x": 0,
                    "y": 0,
                    "w": 200,
                    "h": 143
                },
                "sourceSize": {
                    "w": 200,
                    "h": 143
                }
            }
        ],
        "meta": {
            "app": "Adobe Flash Professional",
            "version": "13.0.0.759",
            "image": "tenki_03.png",
            "format": "RGBA8888",
            "size": {
                "w": 1024,
                "h": 1024
            },
            "scale": "1"
        }
    };
    
    /**
     * コマアニメ用のスプライトシート上の描画領域を
     * Rectangleの配列として定義します。
     *
     * @type {Array.<Rectangle>}
     */
    var FRAMES = [];

    //Flashのjsonを上記フレーム定義に変換します
    for(var i = 0; i < flashExport.frames.length; i++) {
        var frame = flashExport.frames[i].frame;
        FRAMES.push(new Rectangle(frame.x, frame.y, frame.w, frame.h));
    }

    /**
     * Mixinの実装
     *
     * @param target メソッド実装先オブジェクト
     * @param imports メソッド定義
     */
    var mixin = function( target, imports ) {
        for ( var method in imports ) {
            target[method] = imports[method];
        }
    };

    /**
     * アニメーション生成用のSpriteオブジェクトを生成します
     */
    var SpriteAnimationFactory = {
        /**
         *
         *
         * @param {BitmapData} bmd
         * @param {Array.<Rectangle>} frames
         * @returns {Sprite}
         */
        create: function( bmd, frames ) {

            //表示コンテナ
            var sprite = new Sprite();

            //methodsの定義内容をmixin
            mixin(sprite, this.methods);

            //表示用Bitmap
            sprite.bitmap = sprite.addChild( new Bitmap(bmd, false, false, frames[0]) );

            //Frame
            sprite.frames = frames;

            //現在のFrameIndex
            sprite.frameIndex = 0;

            return sprite;
        },
        /**
         * アニメーションの表示コンテナに実装するメソッド
         */
        methods: {
            /**
             * アニメーションの再生
             */
            play: function() {
                var self = this;
                this.update = function() {
                    self.renderFrame(self.frameIndex++);
                    if(self.frameIndex >= self.frames.length) {
                        self.frameIndex = 0;
                    }
                };
                this.addEventListener("enterFrame", this.update);
            },
            /**
             * アニメーションの停止
             */
            stop: function() {
                this.removeEventListener("enterFrame", this.update);
            },
            /**
             * フレームを表示
             */
            renderFrame: function(frameIndex) {
                var frame = this.frames[frameIndex];
                this.bitmap.setClippingRect(frame);
            },
            /**
             * フレームのリセット
             */
            reset: function() {
                this.renderFrame(0);
                this.frameIndex = 0;
            }
        }
    };

    //==============================================
    //　実行処理
    //==============================================
    var stage = new Stage( 320, 480 );
    addLayer( new Layer( stage ) );
    
    //背景を敷き詰めます
    var bg = stage.addChild( new Bitmap( new BitmapData( 1, 1, true, 0xff00ffff ) ) );
    bg.width = stage.stageWidth;
    bg.height = stage.stageHeight;
    
    //画像を読み込みます
    var image = new Image( "assets/images/sheet.png" );

    image.onload = function() {

        //アニメーション表示コンテナを生成してstageに追加
        var cat = SpriteAnimationFactory.create( new BitmapData( image ), FRAMES);
        stage.addChild( cat );

        //再生
        cat.play();
    };

})();

